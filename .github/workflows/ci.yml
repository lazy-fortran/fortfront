name: Tests

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test-linux:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.draft == false)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache FPM binary
      id: cache-fpm
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/fpm
        key: ${{ runner.os }}-fpm-0.12.0
    
    - name: Setup FPM
      if: steps.cache-fpm.outputs.cache-hit != 'true'
      run: |
        wget https://github.com/fortran-lang/fpm/releases/download/v0.12.0/fpm-0.12.0-linux-x86_64-gcc-12
        chmod +x fpm-0.12.0-linux-x86_64-gcc-12
        sudo mv fpm-0.12.0-linux-x86_64-gcc-12 /usr/local/bin/fpm
    
    - name: Cache apt packages
      uses: awalsh128/cache-apt-pkgs-action@v1
      with:
        packages: gfortran lcov
        version: 1.0
    
    - name: Cache FPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/share/fpm
          build/dependencies
        key: ${{ runner.os }}-fpm-deps-${{ hashFiles('fpm.toml') }}
        restore-keys: |
          ${{ runner.os }}-fpm-deps-

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Show compiler versions
      run: |
        gfortran --version
        fpm --version
        python3 --version

    - name: Run tests with coverage
      run: |
        fpm clean --all
        fpm test --profile debug --flag '-cpp -fprofile-arcs -ftest-coverage -g'

    - name: Generate coverage report
      id: coverage
      run: |
        lcov --capture --directory build/ --output-file coverage.info \
          --rc branch_coverage=1 \
          --ignore-errors inconsistent
        lcov --remove coverage.info \
          'build/dependencies/*' \
          'test/*' \
          '/usr/*' \
          --output-file coverage_filtered.info \
          --rc branch_coverage=1
        
        # Extract coverage percentage
        COVERAGE=$(lcov --summary coverage_filtered.info 2>&1 | grep -E "lines\.\.\.\.\.\.: " | sed 's/.*: \([0-9.]*\)%.*/\1/')
        echo "Coverage: ${COVERAGE}%"
        echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
        
        # Generate HTML report
        genhtml coverage_filtered.info --output-directory coverage_html \
          --branch-coverage \
          --legend \
          --title "fortfront Coverage Report"

    - name: Create coverage badge
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        
        # Determine color based on coverage
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          COLOR="green"
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          COLOR="yellow"
        elif (( $(echo "$COVERAGE >= 50" | bc -l) )); then
          COLOR="orange"
        else
          COLOR="red"
        fi
        
        # Create badge JSON
        echo "{\"schemaVersion\": 1, \"label\": \"coverage\", \"message\": \"${COVERAGE}%\", \"color\": \"${COLOR}\"}" > coverage-badge.json
        
        # Create SVG badge
        cat > coverage-badge.svg << EOF
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="114" height="20">
          <linearGradient id="b" x2="0" y2="100%">
            <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
            <stop offset="1" stop-opacity=".1"/>
          </linearGradient>
          <clipPath id="a">
            <rect width="114" height="20" rx="3" fill="#fff"/>
          </clipPath>
          <g clip-path="url(#a)">
            <path fill="#555" d="M0 0h63v20H0z"/>
            <path fill="#${COLOR}" d="M63 0h51v20H63z"/>
            <path fill="url(#b)" d="M0 0h114v20H0z"/>
          </g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
            <text x="31.5" y="15" fill="#010101" fill-opacity=".3">coverage</text>
            <text x="31.5" y="14">coverage</text>
            <text x="86.5" y="15" fill="#010101" fill-opacity=".3">${COVERAGE}%</text>
            <text x="86.5" y="14">${COVERAGE}%</text>
          </g>
        </svg>
        EOF

    - name: Check coverage threshold (PR only)
      if: github.event_name == 'pull_request'
      run: |
        CURRENT_COVERAGE=${{ steps.coverage.outputs.coverage }}
        
        # For PRs, ensure we maintain at least 70% coverage
        if (( $(echo "$CURRENT_COVERAGE < 70" | bc -l) )); then
          echo "⚠️ Warning: Coverage is below 70% threshold (${CURRENT_COVERAGE}%)"
          echo "Please add tests to improve coverage."
        else
          echo "✅ Coverage is ${CURRENT_COVERAGE}%"
        fi

    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          
          let comment = '## 📊 Coverage Report\n\n';
          comment += `**Total Coverage: ${coverage}%**\n\n`;
          
          const coverageFloat = parseFloat(coverage);
          let emoji = '✅';
          if (coverageFloat < 50) emoji = '🔴';
          else if (coverageFloat < 60) emoji = '🟠';
          else if (coverageFloat < 70) emoji = '🟡';
          else if (coverageFloat < 80) emoji = '🟢';
          
          comment += `${emoji} Coverage: ${coverage}%\n\n`;
          
          if (coverageFloat < 70) {
            comment += '⚠️ **Warning:** Coverage is below the 70% threshold.\n';
            comment += 'Please add tests to improve coverage.\n';
          }
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Coverage Report')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage_filtered.info
          coverage_html/
          coverage-badge.svg
          coverage-badge.json
        retention-days: 30

  test-windows:
    runs-on: windows-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.draft == false)
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        path-type: inherit
        cache: true
        release: false
        install: >-
          mingw-w64-x86_64-gcc-fortran
          mingw-w64-x86_64-gcc
          git

    - name: Add MinGW to PATH
      run: echo C:\msys64\mingw64\bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh

    - name: Cache FPM binary (Windows)
      id: cache-fpm-win
      uses: actions/cache@v4
      with:
        path: C:\msys64\mingw64\bin\fpm.exe
        key: ${{ runner.os }}-fpm-0.12.0

    - name: Install FPM
      if: steps.cache-fpm-win.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "Installing FPM directly from GitHub releases..."
        Invoke-WebRequest -Uri "https://github.com/fortran-lang/fpm/releases/download/v0.12.0/fpm-0.12.0-windows-x86_64-gcc-12.exe" -OutFile "fpm.exe"
        Move-Item -Path "fpm.exe" -Destination "C:\msys64\mingw64\bin\fpm.exe"
        & "C:\msys64\mingw64\bin\fpm.exe" --version

    - name: Cache FPM dependencies (Windows)
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\fpm
          build\dependencies
        key: ${{ runner.os }}-fpm-deps-${{ hashFiles('fpm.toml') }}
        restore-keys: |
          ${{ runner.os }}-fpm-deps-

    - name: Cache build artifacts (Windows)
      uses: actions/cache@v4
      with:
        path: |
          build\gfortran_*
          !build\gfortran_*/test
        key: ${{ runner.os }}-build-${{ hashFiles('src/**/*.f90') }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: Run all tests
      shell: cmd
      run: |
        echo "Running all tests..."
        fpm test --flag -cpp

  # macOS CI temporarily disabled due to runner issues
  # test-macos:
  #   runs-on: macos-latest
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #
  #   - name: Setup Micromamba
  #     uses: mamba-org/setup-micromamba@v2
  #     with:
  #       micromamba-version: 'latest'
  #       environment-name: test-env
  #       create-args: >-
  #         python=3.11
  #         fpm
  #         gfortran
  #       init-shell: bash
  #       cache-environment: true
  #       channels: conda-forge
  #
  #   - name: Check versions
  #     shell: bash -el {0}
  #     run: |
  #       echo "GCC version:"
  #       gfortran --version
  #       echo "FPM version:"
  #       fpm --version
  #       echo "GCC/G++ version:"
  #       gcc --version || true
  #       # Check if gcc-15 is available
  #       gcc-15 --version || echo "gcc-15 not found, will try to find appropriate gcc"
  #
  #   - name: Cache FPM dependencies
  #     uses: actions/cache@v4
  #     with:
  #       path: |
  #         ~/.local/share/fpm
  #         build/dependencies
  #       key: ${{ runner.os }}-fpm-deps-${{ hashFiles('fpm.toml') }}
  #       restore-keys: |
  #         ${{ runner.os }}-fpm-deps-
  #
  #   - name: Run all tests
  #     shell: bash -el {0}
  #     run: |
  #       # Set FPM_CC for test runs with proper GCC version
  #       if command -v gcc-15 &> /dev/null; then
  #         export FPM_CC=gcc-15
  #       elif command -v gcc-14 &> /dev/null; then
  #         export FPM_CC=gcc-14
  #       elif command -v gcc-13 &> /dev/null; then
  #         export FPM_CC=gcc-13
  #       else
  #         GCC_PATH=$(which gcc)
  #         if [ -n "$GCC_PATH" ]; then
  #           export FPM_CC=$GCC_PATH
  #         fi
  #       fi
  #       
  #       echo "Using FPM_CC=$FPM_CC"
  #       echo "Running all tests..."
  #       fpm test --flag -cpp